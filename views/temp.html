<!DOCTYPE html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leader-line/1.0.7/leader-line.min.js"></script>
    <style>
        /* Previous styles remain the same */
        /* Add new styles for connection labels */
        .connection-label {
            position: absolute;
            background: white;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 12px;
            cursor: text;
            z-index: 1001;
            min-width: 50px;
            text-align: center;
        }

        .connection-label:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 3px rgba(33, 150, 243, 0.3);
        }

        /* Include all previous styles here */
        /* ... (keep all existing styles) ... */
    </style>
</head>

<body>
    <!-- Keep existing HTML structure -->
    <script>
        // Modify the connections Map to include labels
        const connections = new Map();

        // Update createConnection function to include label
        function createConnection(from, to, options = {})
        {
            const line = new LeaderLine(
                from,
                to,
                {
                    color: '#999',
                    size: 2,
                    path: 'fluid',
                    startSocket: options.startSocket || 'right',
                    endSocket: options.endSocket || 'left',
                    dropShadow: false,
                    startPlug: 'behind',
                    endPlug: 'arrow1',
                    dash: { animation: true }
                }
            );

            // Create label element
            const label = document.createElement('div');
            label.className = 'connection-label';
            label.contentEditable = true;
            label.textContent = 'Label';
            document.body.appendChild(label);

            // Position label
            function updateLabelPosition()
            {
                const linePos = line.position();
                const midX = (linePos.x1 + linePos.x2) / 2;
                const midY = (linePos.y1 + linePos.y2) / 2;

                label.style.left = `${midX - label.offsetWidth / 2}px`;
                label.style.top = `${midY - label.offsetHeight / 2}px`;
            }

            // Initial position
            setTimeout(updateLabelPosition, 0);

            // Update label position when line moves
            const observer = new MutationObserver(() =>
            {
                updateLabelPosition();
            });

            observer.observe(line.element, {
                attributes: true,
                attributeFilter: ['style']
            });

            // Store connection data
            connections.get(from).outgoing.push({ target: to, line, label });
            connections.get(to).incoming.push({ source: from, line, label });

            // Clean up label when line is removed
            const originalRemove = line.remove;
            line.remove = () =>
            {
                originalRemove.call(line);
                label.remove();
                observer.disconnect();
            };
        }

        // Update deleteButton click handler
        function updateDeleteButtonHandler(note, deleteButton)
        {
            deleteButton.addEventListener('click', () =>
            {
                const noteConnections = connections.get(note);
                noteConnections.incoming.forEach(conn =>
                {
                    conn.line.remove();
                    conn.label.remove();
                    const sourceConnections = connections.get(conn.source);
                    sourceConnections.outgoing = sourceConnections.outgoing.filter(out => out.target !== note);
                });
                noteConnections.outgoing.forEach(conn =>
                {
                    conn.line.remove();
                    conn.label.remove();
                    const targetConnections = connections.get(conn.target);
                    targetConnections.incoming = targetConnections.incoming.filter(incoming => incoming.source !== note);
                });

                connections.delete(note);
                note.remove();
            });
        }

        // Update updateLines function to include label updates
        function updateLines(note)
        {
            if (!note || !connections.has(note)) return;

            const noteConnections = connections.get(note);

            noteConnections.incoming.forEach(conn =>
            {
                conn.line.position();
                const linePos = conn.line.position();
                const midX = (linePos.x1 + linePos.x2) / 2;
                const midY = (linePos.y1 + linePos.y2) / 2;

                conn.label.style.left = `${midX - conn.label.offsetWidth / 2}px`;
                conn.label.style.top = `${midY - conn.label.offsetHeight / 2}px`;
            });

            noteConnections.outgoing.forEach(conn =>
            {
                conn.line.position();
                const linePos = conn.line.position();
                const midX = (linePos.x1 + linePos.x2) / 2;
                const midY = (linePos.y1 + linePos.y2) / 2;

                conn.label.style.left = `${midX - conn.label.offsetWidth / 2}px`;
                conn.label.style.top = `${midY - conn.label.offsetHeight / 2}px`;
            });
        }

        // Keep all other existing code
        // ... (rest of the JavaScript code remains the same) ...
    </script>
</body>

</html>